socket              = io.connect('/')
hands               = new HappyHands()
index               = 0
views               = []
orientation         = []
last_orientation    = []
action_names        = []
emit_int            = null

actions             = [
    name    : 'Uppercut'
    records : [[123.46,82.93,53.79,2.11,-6.63,1.34],[141.61,77.51,29.94,1.12,-5.35,0.1],[148.61,71.72,16.52,2.38,-4.47,-0.99],[156.57,65.83,2.58,-0.2,-3.23,-2.34],[163.02,60.01,-11.43,-1.76,-2.44,-1.62],[169.02,52.24,-24.04,-4.76,-0.36,-1.9],[172.92,41.58,-33.83,-2.12,3.46,-7.37],[176.84,28.04,-42.11,-12.85,5,-6.57],[177.49,15.12,-44.67,2.47,8.5,-15.12],[186.23,0.19,-52.83,-4.09,14.09,-10],[196.95,-19.63,-54.3,-4.87,17.95,-12.42],[213.32,-39.57,-50.47,-12.83,19.34,-16.54],[235.39,-51.6,-37.38,-16.79,18.61,-20.58],[260.58,-48.87,-14.72,-6.23,19.56,-20.29],[278.96,-32.59,-3.87,-1.47,19.84,-20.15],[294.09,-8.38,3.04,-6.59,19.75,-20.3],[304.26,18.22,6.64,-8.38,18.95,-15.51],[308.89,40.81,7.09,-6.92,11.25,-9.9],[309.01,59.69,11.28,-2.79,7.18,-3.61],[305.45,74.27,17.53,-2.45,2.54,1.43],[284.27,83.24,42.89,-1.55,0.02,4.32],[264.3,85.2,65.82,-0.65,-3.21,2.46],[256.06,86.92,75.02,-1.36,-6.44,0.42],[275,88.43,57.17,-0.97,-9.55,-1.89],[159.55,89.94,172.91,-1.21,-9.49,-0.35],[150.26,89.77,-177.52,-0.52,-9.59,-0.43],[127.3,89.49,-154.77,-0.51,-9.62,-0.6],[114.73,89.11,-142.16,-0.55,-9.21,-0.12],[104.05,88.26,-131.37,-0.71,-9.4,0.51],[93.56,87.93,-120.86,-0.6,-9.59,-0.29],[99.44,87.23,-125.94,-0.62,-9.76,-0.1],[114.92,86.73,-140.97,-0.21,-10.34,2.31]]
,
    name    : 'Shoot'
    records : [[237.34,79.74,23.27,-1.31,-11.06,-2.5],[220.01,78.8,33.04,-2.27,-12.77,-3.23],[193.67,75.52,48.71,0.29,-13,-2.77],[174.54,69.28,57.92,1.04,-10.7,-3.46],[160.05,60.91,63.46,5.91,-8.56,-3.12],[152.21,53.87,64.06,6.55,-7.66,-4.15],[146.35,46.94,61.5,6.75,-6.17,-5.24],[141.55,41.02,56.03,8.34,-6.98,-5.73],[138.26,36.28,48.96,7.28,-5.94,-7.93],[135.2,33.27,39.22,4.71,-5.95,-5.19],[133.93,30.95,35.12,5.94,-3.24,-11.45],[132.24,39.84,33.84,2.23,0.48,-9.33],[128.47,51.34,36.33,1.56,2.46,-6.85],[116.35,64.91,44.07,1.94,0.27,-7.35],[45.51,77.8,111.84,1.68,5.22,-2.61],[340.42,58.91,-177.44,5.06,6.21,1.55],[328.64,30.19,-173.59,-5.71,6.79,14.06],[327.85,9.65,-169.95,-3.92,-0.11,19.43],[327.44,3.67,-168.75,-0.51,1.29,17.43],[325.85,2.52,-171.78,-2.03,1.91,9.17],[327.22,8.66,-160.35,-3.07,-0.88,7.9],[327.12,11.58,-158.14,-3.98,-1.02,9.05],[327.71,15.14,-155.17,-2.31,-2.97,8.22],[328.91,16.55,-149.89,-4.71,-2.81,8.68],[328.13,17.59,-148.35,-4.67,-2.99,7.89]]
,
    name    : 'Slice'
    records : [[96,80.67,118.4,2.73,-9.07,0.68],[102.5,81.37,113.29,3.58,-7.45,0.59],[118.79,82.98,100.26,8.6,-4.81,-1.39],[187.06,87.58,36.69,7.67,-1.86,-5.13],[281.95,80.25,-50.93,6.12,1.59,-5.8],[296.28,65.72,-55.07,5.11,6.7,-9.06],[307.1,46.34,-53.06,1.61,10.96,-10.06],[317,21.96,-45.96,-0.44,18.02,-16.13],[331.32,-4.97,-39.14,-19.08,16.46,-14.34],[337.23,-20.96,-26.46,-19.11,10.16,-20.62],[342.54,-24.75,-21.66,-19.01,9.51,-20.61],[345.82,-24.03,-18.73,-11.17,6.41,-9.41],[347.81,-22.12,-19.38,-3.78,4.58,-7.32]]
,
    name    : 'Punch'
    records : [[312.78,42.16,-33.67,-3.31,-7.02,-5.28],[315.54,40.88,-35.05,-2.52,-8.38,-4.61],[321,39.6,-40.8,-5.17,-12.5,-2.04],[326.88,38.56,-48.76,-4.98,-16.74,-1.17],[333.17,38.29,-59.35,-3.53,-18.46,4.26],[335.1,36.43,-66.59,-5.21,-11.77,5.22],[331.74,32.33,-71.31,-3.16,2.24,1.38],[324.69,22.46,-78.01,-16.58,15.63,-7.27],[316.32,19.33,-75.9,-9.41,4.66,-20.32],[323.84,21.18,-79.69,-1.35,2.22,12.67],[320.88,20.25,-79.63,-10.97,-0.92,-7.05],[322.29,20.93,-80.34,-8.88,-2.28,0],[323.12,19.66,-84.06,-10.96,-3.49,-1.32]]
,
    name    : 'Slap'
    records : [[42.33,74.04,-56.55,-0.51,-9.44,-1.16],[33.92,72.44,-52.71,0.46,-8.62,-1.53],[19.76,68.13,-41.07,1.54,-5.77,-7.51],[15.17,61.2,-35.81,2.91,-3.2,-18.71],[29.24,51.98,-37.91,2.4,1.46,-19.97],[60.73,43.03,-40.34,-5.08,18.52,-20.25],[111.25,39.43,-50.73,-18.85,19.53,-20.65],[160.4,36.62,-61.83,-18.89,19.53,-18.76],[198.78,35.81,-72.72,-19.21,19.54,-4.43],[228.1,34.06,-79.93,-19.51,13.92,2.05],[247.11,32.49,-84.89,-15.56,8.84,3.62],[258.97,32.67,-87.7,-9.28,4.21,4.2],[267.44,33.05,-90.95,-8.11,-4.97,3.7],[268.25,38.2,-93.13,-7.91,-5.73,2.15]]
,
    name    : 'Slap a Ho'
    records : [[187.67,60.14,-27.87,-8.15,-7.24,0.12],[181.44,53.01,-23.24,-16.93,-4.05,-8.49],[172.71,46.47,-26.07,-19.63,-0.47,-10.12],[156.64,40.66,-32.06,-19.32,7.38,-14.57],[128.89,38.22,-32.79,-18.85,19.53,-20.65],[92.38,40.8,-30.91,-18.85,19.53,-20.65],[46.78,44.66,-14.48,-14.48,19.61,-20.52],[4.25,38.97,-0.07,19.22,20.2,-19.56],[347.87,38.97,-1.34,8.61,9.04,-19.82],[335.12,43.33,2.32,14.16,5.64,-11.09],[328.84,46.56,1.7,8.63,0.3,-6],[324.48,47.45,0.07,5.82,-3.28,-11.73],[323.15,50.35,-3.06,5.87,-4.32,-9.28],[325.37,52.64,-6.99,1.1,-5.96,-7.01],[327.25,53.76,-9.4,-0.56,-6.73,-6.4],[328.47,54.2,-9.11,-0.03,-7.63,-9.06],[334.06,55.9,-11.43,-1.23,-8.22,-7.75],[335.24,56.15,-12.24,-2.2,-8.33,-6.22]]
]



$ ->
    for action in actions
        view = new View action
        views.push view
        action_names.push action.name

    views[0].make()


    $('#start').click ->
        $.ajax
            type    : 'GET'
            url     : '/broadcast/record'
            data    :
                broadcast_id    : socket.socket.sessionid
                secret          : $('#secret').text().trim()
                actions         : action_names

            success : (data) ->
                $('.before').hide()
                $('.recording').show()
                emit_int = setInterval emit_event, 10


    $('#next').click -> next_view()
    $('#prev').click -> prev_view()


window.next_view = ->
    if index < views.length - 1 then index++
    else index = 0

    views[index].make()


window.prev_view = ->
    if index > 0 then index--
    else index = views.length - 1

    views[index].make()


emit_event = (pos) ->

    for item in orientation
        last_orientation[_i] = item

    pass = 0
    for item in orientation
        if (Math.abs(item - last_orientation[_j])) > 5
            pass = 1
            last_orientation[_j] = item

    if pass
        socket.emit 'orientation_change', orientation


window.ondeviceorientation = (e) ->
    orientation[0] = Math.round(e.alpha*100)/100
    orientation[1] = Math.round(e.beta*100)/100
    orientation[2] = Math.round(e.gamma*100)/100


window.ondevicemotion = (e) ->
    orientation[3] = Math.round(e.accelerationIncludingGravity.x*100)/100
    orientation[4] = Math.round(e.accelerationIncludingGravity.y*100)/100
    orientation[5] = Math.round(e.accelerationIncludingGravity.z*100)/100


window.simulate_success = ->
    socket.emit 'test_drive_success', 'true'


class View

    constructor : (action) ->
        @action = action

    make : ->
        socket.emit 'next_view', @action.name

        hands.on @action.records, (=>
            console.log 'emit event'
            socket.emit 'test_drive_success', 'true'
        ),
        kill_on_complete : true